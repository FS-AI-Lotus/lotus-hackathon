# Grafana Alloy Configuration for Team 4 Monitoring
# 
# This configuration scrapes metrics from the Coordinator service
# and forwards them to Grafana Cloud Prometheus.
#
# Usage:
#   alloy run --server.http.listen-addr=0.0.0.0:12345 alloy.config
#
# Or with Docker:
#   docker run -v $(pwd)/alloy.config:/etc/alloy/config.alloy grafana/alloy:latest run /etc/alloy/config.alloy

// Prometheus scrape configuration for Coordinator service
prometheus.scrape "coordinator" {
  targets = [
    {
      __address__ = env("COORDINATOR_HOST"),
      service     = "coordinator",
      environment = env("ENVIRONMENT"),
    },
  ]
  
  forward_to = [prometheus.remote_write.metrics_hosted_prometheus.receiver]
  
  scrape_interval = "15s"
  scrape_timeout  = "10s"
  metrics_path    = "/metrics"
  
  // Add labels to all scraped metrics
  relabel {
    source_labels = ["__address__"]
    target_label  = "instance"
  }
  
  relabel {
    source_labels = ["service"]
    target_label  = "service"
  }
  
  relabel {
    source_labels = ["environment"]
    target_label  = "environment"
  }
}

// Remote write to Grafana Cloud Prometheus
prometheus.remote_write "metrics_hosted_prometheus" {
  endpoint {
    name = "hosted-prometheus"
    url  = "https://prometheus-prod-53-prod-me-central-1.grafana.net/api/prom/push"

    basic_auth {
      username = "2805139"
      password = env("GRAFANA_CLOUD_TOKEN") // Replace with your actual Grafana Cloud token
    }
  }
}

// Optional: Add additional scrape targets for microservices
// Uncomment and configure when microservices are ready
// prometheus.scrape "microservices" {
//   targets = [
//     {
//       __address__ = "microservice1:3001",
//       service     = "microservice1",
//     },
//     {
//       __address__ = "microservice2:3002",
//       service     = "microservice2",
//     },
//   ]
//   
//   forward_to = [prometheus.remote_write.metrics_hosted_prometheus.receiver]
//   
//   scrape_interval = "15s"
//   scrape_timeout  = "10s"
//   metrics_path    = "/metrics"
// }

